# 无牙颌牙合平面生成系统

一个专业的无牙颌牙合平面自动生成与可视化系统，用于口腔医学领域的数字化设计和分析。

## 项目介绍

本系统基于Python开发，集成了先进的3D模型处理和分析算法，能够导入上颌、下颌和咬合关系STL模型，自动生成符合医学标准的牙合平面，并提供直观的3D可视化界面进行模型查看和交互。

### 核心功能

### 基础功能
- **多模型导入**：支持导入上颌、下颌和咬合关系STL格式模型
- **自动对齐**：智能对齐上下颌模型，确保解剖学位置正确
- **牙合平面生成**：提供多种平面生成算法（最佳拟合、解剖学特征、唇系带参考、三点中点法、牙槽嵴平分线法、合并牙槽嵴点集法）
- **质量评分系统**：实时评估生成平面的准确性和稳定性，提供综合质量评分
- **实时可视化**：高性能3D渲染，支持模型旋转、缩放、平移
- **交互控制**：模型可见性切换、透明度调整、平面显示控制
- **结果导出**：支持保存颌平面参数和生成的平面模型
- **详细日志**：完整的处理过程日志，便于调试和分析

### 深度图分析功能
- **实时预览**：标记第一个点时开始生成低分辨率深度图预览
- **多视图比较**：2x2布局显示原始深度图、增强深度图、3D表面图、等高线图
- **对比度调节**：精确的深度范围滑块控制和自动对比度功能
- **色彩映射**：多种色彩方案选择（gray, viridis, plasma, hot, cool, jet）
- **区域统计**：计算深度统计信息（最小值、最大值、平均值、标准差）
- **剖面线分析**：绘制剖面线并显示深度分布曲线
- **测量工具**：距离和角度测量功能
- **高级导出**：支持PNG、SVG、TIFF、PDF、RAW数据格式导出

## 技术栈

- **Python 3.8+**：核心编程语言
- **PyQt5**：图形用户界面框架
- **Open3D**：3D几何处理库
- **PyVista/PyVistaQt**：高性能3D可视化
- **NumPy**：科学计算
- **SciPy**：高级科学算法

## 系统要求

- Windows 10/11 64位系统
- Python 3.8 或更高版本
- 至少8GB内存
- 支持OpenGL的图形卡

## 安装步骤

### 1. 克隆或下载项目

将项目文件下载到本地目录：

```bash
# 假设已下载到 D:\Edentulous Plane 目录
```

### 2. 安装依赖

使用pip安装所有必要的依赖包：

```bash
cd "D:\Edentulous Plane"
pip install -r requirements.txt
```

### 3. 运行程序

安装完成后，直接运行主程序：

```bash
python main.py
```

## 使用指南

### 基本操作流程

1. **导入模型**：
   - 点击"导入上颌模型"按钮，选择上颌STL文件
   - 点击"导入下颌模型"按钮，选择下颌STL文件
   - （可选）点击"导入咬合关系模型"按钮，选择咬合关系STL文件

2. **生成牙合平面**：
   - 选择平面生成方法（最佳拟合、解剖学特征、唇系带参考）
   - 点击"生成牙合平面"按钮开始计算
   - 等待计算完成，平面将在3D视图中显示

3. **查看和调整**：
   - 使用鼠标在3D视图中旋转、缩放、平移模型
   - 调整模型可见性和透明度以获得最佳观察效果
   - 查看平面参数和统计信息
   - 解读质量评分：查看综合评分和详细指标，评估平面质量
   - 根据评分结果选择是否重新生成平面或调整参数

4. **导出结果**：
   - 保存牙合平面参数到文本文件
   - 导出带平面的3D模型

### 3D视图交互

- **旋转**：按住鼠标左键并拖动
- **缩放**：使用鼠标滚轮或按住鼠标右键并拖动
- **平移**：按住鼠标中键并拖动

## 平面生成方法说明

### 1. 最佳拟合平面

使用最小二乘法对模型表面点进行平面拟合，适用于表面比较平整的模型。计算速度快，但可能会受到模型边缘点的影响。

### 2. 解剖学特征平面

基于解剖学知识，自动识别并使用牙槽嵴顶区域的点进行平面拟合，更符合临床需求。适合大多数无牙颌模型的处理。

### 3. 唇系带参考平面

结合唇系带附着点和前部区域特征生成平面，在某些特殊病例中可能更适用。

### 4. 三点中点法 (midpoint_plane)

通过识别上下颌模型的关键点（如最前点、最后点），计算这些点的中点来生成平面。这种方法简单直观，适合上下颌关系清晰的模型。

### 5. 牙槽嵴平分线法 (alveolar_crest_bisector)

基于牙槽嵴顶区域的点集，计算上下颌牙槽嵴之间的平分线平面。这种方法考虑了上下颌之间的解剖学关系，适合需要平衡上下颌位置的情况。

### 6. 合并牙槽嵴点集法 (combined_crest_plane)

将上下颌的牙槽嵴点集合并后进行平面拟合，生成一个综合考虑上下颌特征的平面。这种方法提供了更全面的解剖学参考。

## 质量评分系统

### 评分概述

质量评分系统用于评估生成平面的准确性和稳定性，采用0-100分制。评分基于以下关键指标：

- **平面度评分**：评估生成平面的平整程度
- **拟合精度得分**：评估平面与解剖学特征点的拟合程度
- **接触点数量**：评估平面覆盖的有效解剖学点数量
- **距离统计**：评估点到平面的平均距离和标准差

### 评分计算

综合质量评分通过加权计算得到：
```
quality_score = (planarity_score * 0.3) + (fit_score * 0.4) + (contact_points_score * 0.3)
```

其中：
- `planarity_score`：平面度评分（0-1）
- `fit_score`：拟合精度得分（0-1）
- `contact_points_score`：接触点数量评分（0-1）

### 评分解释

- **90-100分**：优秀 - 平面生成非常准确，符合解剖学标准
- **70-89分**：良好 - 平面生成较好，可以接受
- **50-69分**：一般 - 平面生成需要进一步调整
- **0-49分**：差 - 平面生成可能存在严重问题，建议重新生成

### 质量指标详情

除了综合评分外，系统还提供以下详细指标：

- **平面方程**：平面的数学表达式（Ax + By + Cz + D = 0）
- **法向量**：平面的法向量
- **夹角**：平面与参考平面的夹角
- **点到平面距离**：所有接触点到平面的距离统计
- **接触区域分布**：接触点在平面上的分布情况

## 项目结构

```
Edentulous Plane/
├── main.py                 # 应用程序入口
├── requirements.txt        # 依赖包列表
├── README.md               # 项目文档
├── ui/                     # UI模块
│   ├── __init__.py
│   ├── main_window.py      # 主窗口界面
│   └── model_viewer.py     # 3D模型查看器
├── processing/             # 处理模块
│   ├── __init__.py
│   ├── model_loader.py     # 模型加载和预处理
│   └── plane_generator.py  # 牙合平面生成算法
└── utils/                  # 工具函数
    ├── __init__.py
    └── helpers.py          # 辅助功能函数
```

## 常见问题解答

### Q: 导入模型失败怎么办？

A: 请检查以下几点：
- 确保文件是STL格式
- 确保文件没有损坏
- 检查文件路径是否包含中文或特殊字符
- 查看程序日志以获取详细错误信息

### Q: 生成的平面不理想如何调整？

A: 可以尝试以下方法：
- 选择不同的平面生成方法
- 调整平面生成参数（如采样比例）
- 确保上下颌模型正确对齐
- 检查模型质量，可能需要先进行修复

### Q: 程序运行缓慢怎么办？

A: 可以尝试：
- 减少模型复杂度
- 增加采样比例参数
- 关闭不必要的显示选项
- 确保系统满足最低硬件要求

## 故障排除

### 内存错误

如果处理大型模型时出现内存错误，请：
- 增加系统虚拟内存
- 简化输入模型（减少顶点数量）
- 关闭其他占用内存的程序

### 图形显示问题

如果3D视图显示异常，请：
- 更新显卡驱动
- 确保OpenGL版本兼容
- 尝试降低模型复杂度

## 开发者信息

### 扩展开发

如需扩展功能，可以按照以下步骤：
1. 在相应模块中添加新功能
2. 确保所有函数都有适当的错误处理和日志输出
3. 保持代码风格一致，使用类型提示
4. 添加单元测试以确保功能正常

### 日志系统

程序使用标准输出进行日志记录，包括：
- 操作开始和完成通知
- 处理进度信息
- 错误和警告信息
- 关键参数和结果

## 许可证

本项目仅供研究和教学使用，商业使用请联系开发者。

## 致谢

感谢所有为项目提供帮助和支持的研究人员和开发者。

## 联系方式

如有问题或建议，请联系开发团队。

---

**版本**：1.1.0
**发布日期**：2025年5月
**更新日志**：
- 初始版本发布
- 支持三种平面生成算法
- 完整的3D可视化交互
- 多模型导入和自动对齐功能
- 新增三种平面生成方法：三点中点法、牙槽嵴平分线法、合并牙槽嵴点集法
- 添加质量评分系统，评估生成平面的准确性和稳定性
- 优化异常处理机制，提高系统稳定性
- 更新测试脚本，支持验证所有平面生成方法